# 1/12 全体発表用下書き

## 共通- 多田
電気分野の高橋開人、電子分野の水野拓真、機械分野の水野俊太、情報科の小松迅人、多田隆人、吉田瞬吏、都市環境分野 山本 紘夢, 中野 瑛翔です。  
よろしくお願いします。

目次です。このように進めていきます。

### はじめに - 多田
近い将来に完全な自動運転が始まり、  
その後は全ての車が自動運転されると思います。  
私たちはそんな未来での都市について5分野計8人で協力し、  
研究しようと思いました。

私たちは未来の都市における自動運転をテーマに
- 機械分野 は車体の設計を
- 電子分野 は車の制御
- 電気分野 はワイヤレス給電
- 情報科 は自動運転の一括制御
- 都市環境分野 は街の設計

を担当しました。  
今回の発表では 電子分野代表の`機体チーム` と 情報科代表の `情報チーム` の発表を合同で行います。  

### 問題提起
続いて問題提起です。  
現在の電気自動車は充電に時間が掛かるため、走行しながら充電できるシステムを製作します。  
また自動運転では画像認識が主体ですが、気候により視界が悪くなるなど、認識しづらい場合があります。  
そして信号は非混雑時にも停止する場合があり、柔軟性に欠けていて、効率的では無いと考えました。  
そこで私たちが提案する新システムではタグを用いて、無駄な一時停止を減らすことを目標としました。  


### 前提条件 - 山本
前提として `都市環境分野チーム` によって都市はこのように設計されています。  
(デッキを見せる)  デッキによって人と車の生活する空間を分けることで車と人の事故を無くし、  
車の移動をより早く、人の移動をより安全に・楽しくなるような工夫がされています。  
また、車は全て完全自動運転されており、今回は片側1車線で検証します。


## 電気/電子/機械分野

### 機械分野 - 水野竣太
はじめに機械分野が機体を制作しました。  
Inventorという3DCADのソフトで3Dモデルを作り、そのデータを3Dプリンターで印刷しました。  
また車体には以下のものを搭載しています。

マイコンには
- Arduino
- Raspberry Pi
- M5stack

などがある中、ESP32を選んだ理由は
- WiFi, Bluetoothが搭載されていること
- 車体に搭載できる大きさであること
- 安価であること

が上げられます。  
また、その中でも`LOLIN D32`はコネクターがあり、バッテリーとの接続が容易です。

### 電子分野 - 水野拓真
続いて電子分野です。

概要としては自動走行中に交差点等の地面に埋め込まれているNFCタグをRFIDリーダーで検知し、待機、直進、左折、右折をさせます。

私の当初の目標は地面に埋め込まれた磁石を用いた磁気トレースで自動走行をさせようとしていました。
しかし、磁気センサーには2つの問題点がありました。
- １つ目は磁気センサーを使った時にRFIDリーダーが正常に動作しないこと
- 2つ目は無線自動給電から影響を受けることです。

このことから、目標を赤外線反射センサーを用いたライントレースでの自動走行に変更しました。  
今回は自動走行の制御にPID制御を使用しました。

ライントレースをしながらNFCタグを検知し、
情報チームと通信しながら実行する予定でしたが、  
合わせる前に元からNFCタグの情報を入れておき、簡易的に動かしてみました。

こちらが実際の動作です。

試走実験をする床によってNFCタグが反応しない事があったので原因を調べた結果タグが反応しない床には  
鉄が埋め込まれている事が分かりました。  
この事から、このシステムを導入するにあたって水道管などの地中の鉄から影響を受けてしまうのではないかと考えました。  

今後の課題としては、地中に鉄があっても支障なくシステムが動作できるようにすることです。  
また、情報科と合わせて、取得した最短経路を指示通りに辿れるようにしたいです。

### 電気分野 - 高橋
次に電気分野です。

概要は、コイルを用いて `地面に埋め込む自動給電回路` と `車体に搭載する受電回路` を作成しモデル化することです。

ここで問題となってくるのが受電コイルを車体に搭載するため、
コイル間にできてしまう「ズレ」によって給電効率が落ちてしまうことです。  
そこでいくつかある給電方式の中から `電磁誘導磁界共鳴方式` を用いることで**ズレ**への対策としました。

これを元にキットを購入し回路製作を始めました。  
電子の自動走行の回路にバッテリーとキットの受電回路をつなげて `搭載する回路`、
キットの給電回路にタクトスイッチを付けて `地面に埋め込む回路` としました。

搭載する回路を使ってバッテリーへの充電実験を行いました。  
バッテリーが空の状態で給電を行い、ESP32 とバッテリーの間の電圧を1分間測り続けると  
電圧が0.155V, 電流が0.15mA上がり少量ではありますが、バッテリーへの充電ができていることが確認できました。

問題としては実験でバッテリーに流れる電流の大きさがあまりにも小さすぎました。  
原因はesp32に搭載されている充電回路内の保護回路だと考えました。  
今後の課題としては、自作で保護回路のない充電回路を作成し、受電した電流をそのままバッテリーに充電すること、  
給電側にタクトスイッチを設けて、自動給電回路を実現することです。  

## 情報科
続いて情報科学科です。

### 問題提起・目標 - 多田
この機体を制御するにはサーバー側で処理する必要があり、情報チームはこれを制作します。  

### システムについて
#### 制作物 - 多田
socket通信で車側と通信するプログラムを制作し、他の分野と合わせる前に、
システムの有効性を検証するためにシミュレータを制作しました。  

システム構成はこのようになっています。  
各クライアントとサーバーはsocket通信で接続されており、   
コントローラーを介して制御されています。  
データベースにはクライアントの接続状況とタグの情報が保存されています。

#### Python について - 多田
使用した言語は `Python3.8` です。  
処理は遅いですが、習得がC言語などに比べて容易で、チーム開発する上で扱いやすいためPythonを選びました。  

使用したライブラリは以下の通りです。  
- `socket` はサーバーと車でsocket通信するためのもの  
- `sqlite3` は sqlite というデータベースを操作するため  
- `concurrent.futures` はマルチスレッドで同時処理をおこなうため  

のライブラリです。

#### A*アルゴリズム について - 吉田
今回のシミュレーションではある交差点から交差点への最短経路を求める必要があるため
`A*アルゴリズム` を使用しました。

最短経路探索には基本となる `ダイクストラ法` があり、
これは隣接する交差点から順々に走査するものです。  
ただし、ゴールとは関係ない方向にも走査するため無駄が多いです。

このダイクストラ法にゴールまでの直線距離の情報も加えて計算し、
効率よく探索できるようにしたものがA*アルゴリズムです。


#### 新システムについて - 吉田
新システムは交差点にタグが配置されていて、1つ目のタグを通るとサーバーに接続報告されます。  
サーバーでは交差点に進入できるかの判断をし、この結果が車側に返されます。  
交差点通過後は車から通過報告をし、この交差点での通信を終了します。  

判断する条件は以下のようになっています。  
> 自分: 待機中の車  
> 相手: 進入中の車  
> 拒否: 自分の待機しているレーンに進入不可の車がある  
> 
> 許可: 自分と相手の来る方が同じ  
> 
> 拒否: 自分の行き先と相手の行き先が同じ  
>  
> 自分が直進のとき
> - 拒否: 相手が自分の左側から来る  
> - 拒否: 相手が自分の左側へ行く  
> 
> 自分が右折のとき
> - 拒否: 相手が左から来て前に行く
> - 拒否: 相手が前から来て左に行く
> - 許可: 相手が右から来て手前に行く

これを実装するには車の来る方角,進行方向を判別する必要があります。  
自分が直進する場合の一例を見てみると、  
`自分から見て左側から相手が来る` かを判断するだけで  
東西南北それぞれ4パターンあり、判断基準が増えてしまいます。  
> - 自分が`北`にいて、相手が`東`から来る場合
> - 自分が`東`にいて、相手が`南`から来る場合
> - 自分が`南`にいて、相手が`西`から来る場合
> - 自分が`西`にいて、相手が`北`から来る場合

ここで`北を0, 東を1, 南2, 西3` `左折を1, 直進2, 右折3`とすることにより、このように処理を効率化することができました。  
> - `相手の来る方` == `自分の来る方 + 1`  

### 検証 1回目 - 吉田
#### 検証内容について
続いて検証の内容と結果です。  
シミュレーターは信号と新システム2つを制作しました。  

このようにシミュレーターに合わせてプログラムの構成を変えました。  
信号と新システムは交差点制御を変更することで切り替わります。  
クライアントはサーバー側に取り込まれ、時間差で自動で立ち上がるようになりました。  
さらに、放置するだけで様々な条件下で何度でもシミュレートできるようにもなっています。  

新システムの1つ目は来た車から1台ずつ進入するようにしたもので、  
2つ目はこれを同時に進入できるようにしたものです。  
これらをnew1、new2と呼ぶことにします。  

こちらはシミュレーターを実行している様子です。  
iMac6台でそれぞれ9個、計54個を同時に実行しています。

交差点単体に着目しランダムな方角から方角へ移動する車を5分間の処理数と待機数で比較します。  


#### 検証結果
こちらが結果をグラフ化したものです。  
![1-処理数](https://docs.google.com/spreadsheets/d/e/2PACX-1vSDcloY71481hB0FpkomezlnNjGZpPEFegFVnGm2JX5h_pkD8_AO-UcSNwicodauZi7aXvQntKbFgBz/pubchart?oid=1751094130&format=image)  
![1-待機数](https://docs.google.com/spreadsheets/d/e/2PACX-1vSDcloY71481hB0FpkomezlnNjGZpPEFegFVnGm2JX5h_pkD8_AO-UcSNwicodauZi7aXvQntKbFgBz/pubchart?oid=1814756461&format=image)  

処理数のグラフよりnew1は同時進入できなく制限されるため、一定となっています。  
それに対しnew2の混雑時は信号に勝っています。  
車の間隔が広くなるにつれ等しくなっていますが、
待機数のグラフより待機数が限りなく少ないため共に車を捌き切れていると分かります。  

交差点単体では、同時進入の重要性など良い結果が得られました。  
次はマップ全体として検証しました。  


### 検証 2回目 - 多田
#### システム変更点・検証方法
変更点として、 12x12 のおよそ碁盤の目状のマップでランダムな交差点から交差点へと移動します。  
経路探索を効率的に行うために `Astarアルゴリズム` を使用します。  
信号とnew2の5分間の処理数と待機数で比較します。  
また、交差点が混雑していた場合はそこを回避するものも比較します。  

変更後のシステムはこのようになっています。  
交差点の数だけ交差点制御が立ち上げられ、最短経路を得るためのシステムが追加されています。

#### 検証結果
こちらも同様にグラフ化しました。  
![2-処理数](https://docs.google.com/spreadsheets/d/e/2PACX-1vSDcloY71481hB0FpkomezlnNjGZpPEFegFVnGm2JX5h_pkD8_AO-UcSNwicodauZi7aXvQntKbFgBz/pubchart?oid=522272234&format=image)  
![2-待機数](https://docs.google.com/spreadsheets/d/e/2PACX-1vSDcloY71481hB0FpkomezlnNjGZpPEFegFVnGm2JX5h_pkD8_AO-UcSNwicodauZi7aXvQntKbFgBz/pubchart?oid=1762092698&format=image)  

new2は信号より処理数が多く待機数が少ない理想的な状況で、特に混雑時は差が顕著に出ていました。  
これは交差点単体での遅延は少なくても経路全体とすると大きくなってしまっているからだと考えられます。  
また、信号は混雑度に関わらず一定数待機する必要がありますが、new2はあまり待機する必要がなくなったことが分かります。  
しかし、信号もnew2も回避なしの方がよいため、混雑により回避できる経路がなく余計な処理が増えたと思われます。  


### 情報科の結論 - 多田
シミュレートしてみた結果、目標通りのシステムだと分かりました。  
Y字路の追加など、より現実的な構造にしてデータをとる必要があると考えます。  


## 共通
### 結論
各分野ではいい結果が得られました。  
今後は各分野の成果を結集し、改良を重ねていきたいと思います。

以上です。ご静聴ありがとうございました。  
fin
